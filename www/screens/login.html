<div class="first-screen-layers">
  <div class="first-screen layer">
    <div class="table">
      <div class="row">
        <div class="cell"></div>
      </div>
      <div class="row">
        <div class="cell">
          <div class="content-first-screen">
            <span class="icon-people-bubble"></span>
            <h4>Bienvenido a AccessIn</h4>
            <h5>Comunidades inteligentes, Comunidades felices</h5>
            <button class="btn btn-block btn-white" type="button" onclick="cs.register();" id="btn_register">Aún no estoy registrado</button>
            <button class="btn btn-block btn-line" type="button" onclick="cs.activeLogin();">Ya estoy registrado</button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="cell"></div>
      </div>
    </div>
  </div>

  <div class="login layer">
    <div class="table">
      <div class="row">
        <div class="cell"></div>
      </div>
      <div class="row">
        <div class="cell">
          <form class="content-first-screen">
            <span class="icon-people-bubble"></span>
            <h4>Iniciar sesión en AccessIn</h4>
            <h6>EMAIL</h6>
            <input type="email" name="email">
            <h6>CONTRASEÑA</h6>
            <input type="password" name="password">
            <button class="btn btn-block btn-text" type="button" onclick="cs.activeForgotPassword();">¿Olvidaste tu contraseña?</button>
            <button class="btn btn-block btn-login" type="submit" id="submit">Iniciar Sesión</button>
            <button class="btn btn-block btn-text" type="button" onclick="cs.back();">VOLVER</button>
          </form>
        </div>
      </div>
      <div class="row">
        <div class="cell"></div>
      </div>
    </div>
  </div>

  <div class="forgot-password layer">
    <div class="table">
      <div class="row">
        <div class="cell"></div>
      </div>
      <div class="row">
        <div class="cell">
          <form class="content-first-screen">
            <span class="icon-people-bubble"></span>
            <h4>Recuperar contraseña</h4>
            <h5>Se enviará un email con intrucciones para recuperar tu contraseña.</h5>
            <h6>EMAIL</h6>
            <input type="email" name="email">
            <button class="btn btn-block btn-forgot-password" type="submit" id="submit">Recuperar contraseña</button>
            <button class="btn btn-block btn-text" type="button" onclick="cs.back();">VOLVER</button>
          </form>
        </div>
      </div>
      <div class="row">
        <div class="cell"></div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  function c(){
    this.dev_count = 0;
    this.is_processing = false;
    this.email_login = undefined;
    this.password_login = undefined;
    this.one_signal_ids;
    this.type_server = "real";
    this.status = "first_screen";

    this.start = function(opts){
      opts = opts || {};

      app.windowResize = function(){
        Extends.scrollToInputFocus('.layer');
      };

      $('.forgot-password form').submit(function(){
        cs.processForgotPassword();
        return false;
      });

      $('.login form').submit(function(){
        cs.processLogin();
        return false;
      });

      app.pageLoading('hide');

      if(opts.success_register){
        setTimeout(function(){
          Alert.open('Bienvenido','Ingresa con tus datos para comenzar a disfrutar de AccessIn.','Aceptar');
        },200);
      }
    }

    this.processLogin = function(){
      var form = Extends.serializeForm('.login form');

      if(form.email.search("connecttotest@accessin.net") == 0){
        this.type_server = 'test';
        $('.login #email').val('');
        $('.icon-people-bubble').attr('class','fa fa-wrench login-logo');
        return false;
      }

      if(form.email == "demoapple@accessin.net"){
        this.type_server = 'test';
      }

      document.activeElement.blur();
      $("input").blur();

      $('.login #submit').html('<i class="fa fa-circle-o-notch fa-spin"></i>');
      $('.login #submit').prop('disabled', true);
      this.is_processing = true;
      this.email_login = form.email;
      this.password_login = form.password;

      PrivateData.clear();
      PrivateData.set('is_login',false);
      PrivateData.set('type_server',this.type_server);

      var ids = this.oneSignalReady();

      if(ids){
        Server.send({
          route : [Server.serverUrl(this.type_server),'app','new_login'],
          data : {
            login: form,
            device: {
              model: device.model,
              platform: device.platform,
              version: device.version,
              uuid: localStorage.uuid,
              one_signal_push_token: ids.pushToken,
              one_signal_user_id: ids.userId,
              original_uuid: device.uuid
            }
          },
          callback : function(data, success){
            if(success){
              console.log(data);
              if(data.demo){
                PrivateData.set('is_demo', true);
                PrivateData.set('is_login',true);
                PrivateData.set('logined_version',app.VERSION);
                PrivateData.set('current_person_id',0);
                PrivateData.set('email_logined','demo@accessin.net');
                PrivateData.set('current_auth_code','demo_owner');
                PrivateData.set('current_server_portal','http://demo.accessin.net');
                PrivateData.set('current_authorizations_number',1);

                app.ifDemo();
                app.updateConfig(function(){
                  app.loadScreen(app.SCREENS.WELCOME);
                });

              }else if(data.auths.length == 0){
                Alert.open('Datos incorrectos','El email y la contraseña no son correctos.','Aceptar');
              }else{
                console.log(data);

                var real_auths = [];

                for(var i in data.auths){
                  if(!data.auths[i].auths[0].false_auth){
                    real_auths.push(data.auths[i]);
                  }
                }

                console.log(real_auths)

                PrivateData.set('email_logined',cs.email_login);
                PrivateData.set('is_login',true);
                PrivateData.set('logined_version',app.VERSION);
                if(real_auths.length > 0){
                  PrivateData.set('country_server_id',real_auths[0].id);
                  PrivateData.set('country_server_url',real_auths[0].host);
                  PrivateData.set('current_person_id',real_auths[0].auths[0].person_id);

                  app.loadScreen(app.SCREENS.SELECT_AUTH, real_auths);
                }else{
                  PrivateData.set('password_logined',cs.password_login);

                  app.loadScreen(app.SCREENS.SET_REGISTRATION_CODE);
                }
              }
            }else{
              Alert.open('Lo sentimos','Ocurrió un error, intenta nuevamente por favor.','Aceptar');
            }

            $('.login #submit').html('INGRESAR');
            $('.login #submit').prop('disabled', false);
            cs.is_processing = false;
          }
        });
      }
    }

    this.processForgotPassword = function(){
      var form = Extends.serializeForm('.forgot-password form');

      document.activeElement.blur();
      $("input").blur();

      $('.forgot-password #submit').html('<i class="fa fa-circle-o-notch fa-spin"></i>');
      $('.forgot-password #submit').prop('disabled', true);
      this.is_processing = true;

      Server.send({
        route : [Server.serverUrl(),'app','request_reset_password'],
        data : form,
        callback : function(data, success){
          if(success){
            if(data.status == 'success'){
              Alert.open('Exitosamente','Se envió un email con instrucciones para recuperar su contraseña.','Aceptar');
            }else{
              Alert.open('Email incorrecto','El email ingresado no se encuentra registrado.','Aceptar');
            }
          }else{
            Alert.open('Lo sentimos','Ocurrió un error intenta nuevamente por favor.','Aceptar');
          }

          cs.is_processing = false;
          $('.forgot-password #submit').html('Recuperar Contraseña');
          $('.forgot-password #submit').prop('disabled', false);
        }
      })
    }

    this.oneSignalReady = function(){
      if(this.one_signal_ids){
        return this.one_signal_ids;
      }else{
        if(app.onesignal_active && window.plugins.OneSignal && window.plugins.OneSignal.startInit){
          window.plugins.OneSignal.getIds(function(ids){
            cs.one_signal_ids = ids;
            cs.processLogin();
          });
          return false;
        }else{
          return {
            pushToken: "",
            userId: ""
          };
        }

      }
    }

    this.activeLogin = function(){
      $('.app>.content .page .layer').addClass('active-login');
      this.status = "login";
    };

    this.activeForgotPassword = function(){
      $('.app>.content .page .layer').addClass('active-forgot-password');
      this.status = "forgot_password";
    };

    this.back = function(){
      if(this.status == "login"){
        $('.app>.content .page .layer').removeClass('active-login');
        this.status = "first_screen";
      }else if(this.status == "forgot_password"){
        $('.app>.content .page .layer').removeClass('active-forgot-password');
        this.status = "login";
      }else{
        navigator.app.exitApp();
      }
    };

    this.register = function(){
      $('#btn_register').html('<i class="fa fa-spin fa-circle-o-notch"></i>');
      cordova.InAppBrowser.open('http://accessin.net/sign_in?f=1&from_app=1', '_system');

      setTimeout(function(){
        $('#btn_register').html('Aún no estoy registrado');
      },2000);
      //app.loadScreen(app.SCREENS.REGISTER_TERMS_AND_CONDITIONS);
    }

    this.dev = function(){
      this.dev_count++;

      if(this.dev_count > 50){
        app.loadScreen(app.SCREENS.DEVELOPER);
      }
    }

  }
</script>