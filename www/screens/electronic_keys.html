<div class="list electronic_keys normal">
</div>

<div id="example" style="display: none;">
  <div class="row">
    <div class="icon">
      <div class="circle">
        <span class="icon-key_bold"></span>
      </div>
    </div>
    <div class="info">
      <h5 id="name"></h5>
    </div>
  </div>
</div>

<div class="electronic_keys-personal-code">
  <div class="content">
    <div class="legend">PIN Personal</div>
    <div class="code" id="code"></div>
    <div class="error">* PIN incorrecto</div>
    <div class="content-keyboard">
      <div class="keyboard">
        <div class="row">
          <div class="key"><button type="button" onclick="cs.buttonDown('7')">7</button></div>
          <div class="key"><button type="button" onclick="cs.buttonDown('8')">8</button></div>
          <div class="key"><button type="button" onclick="cs.buttonDown('9')">9</button></div>
        </div>
        <div class="row">
          <div class="key"><button type="button" onclick="cs.buttonDown('4')">4</button></div>
          <div class="key"><button type="button" onclick="cs.buttonDown('5')">5</button></div>
          <div class="key"><button type="button" onclick="cs.buttonDown('6')">6</button></div>
        </div>
        <div class="row">
          <div class="key"><button type="button" onclick="cs.buttonDown('1')">1</button></div>
          <div class="key"><button type="button" onclick="cs.buttonDown('2')">2</button></div>
          <div class="key"><button type="button" onclick="cs.buttonDown('3')">3</button></div>
        </div>
        <div class="row">
          <div class="key"><button type="button" onclick="cs.buttonDown('erase')">
            <i class="fa fa-times"></i>
          </button></div>
          <div class="key"><button type="button" onclick="cs.buttonDown('0')">0</button></div>
          <div class="key"><button type="button" onclick="cs.buttonDown('submit')" class="check" disabled>
            <i class="fa fa-check"></i>
          </button></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="electronic_keys-opendoor">
  <div class="block" id="waiting">
    <i class="fa fa-circle-o-notch fa-spin"></i>
    <h5>Abriendo Puerta...</h5>
    <h4>Powered By<br><b>QrAccess.org</b></h4>
  </div>
  <div class="block" id="success">
    <i class="fa fa-check-circle-o"></i>
    <h5>Puerta Abierta</h5>
    <button type="button" class="btn btn-orange btn-block text-uppercase" onclick="cs.endOpen()">Continuar</button>
    <h4>Powered By<br><b>QrAccess.org</b></h4>
  </div>
</div>

<script type="text/javascript">
  function c(){
    this.callback_get_data;
    this.code = [];
    this.status = "list";

    this.start = function(){

      app.liActive('electronic_keys');
      this.getInfo(function(){
        app.pageLoading('hide');
      });
    }

    this.getInfo = function(callback){
      this.callback_get_data = callback;

      Server.send({
        route : [PrivateData.get('current_server_portal'),'app',"v" + app.PORTAL_VERSION,'electronic_keys','index'],
        data : {},
        callback : function(data, success){
          console.log(data);
          if(success){
            for(var i in data.devices){
              var device = data.devices[i];
              var tmp = $('#example').clone().appendTo('.list.electronic_keys');
              tmp.removeAttr('id');
              tmp.addClass('item');

              tmp.find('#name').html(device.name);
              tmp.attr('data-id', device.id);

              tmp.tap(function(){
                var id = $(this).data('id');

                cs.tryOpenDoor(id);
              });

              tmp.show();
            }

            cs.callback_get_data();
          }else{
            Alert.open('Lo Sentimos','Ocurrió un error al intentar recibir los datos, por favor intenta nuevamente.','Aceptar');

            app.loadScreen(app.SCREENS.DASHBOARD);
          }
        }
      });
    }

    this.updateCodeAsterisks = function(){
      var tmp = [];

      for(var i in this.code){
        tmp.push('<i class="fa fa-asterisk"></i>');
      }

      $('.electronic_keys-personal-code .keyboard button.check').prop('disabled',this.code.length != 4);

      $('.electronic_keys-personal-code #code').html(tmp.join(''));
    }

    this.tryOpenDoor = function(id){
      this.door_id = id;
      $('.electronic_keys-personal-code button').prop('disabled', true);
      $('.electronic_keys-personal-code').show();
      this.code = [];
      this.updateCodeAsterisks();

      this.status = "personal_code";

      setTimeout(function(){
        $('.electronic_keys-personal-code button').prop('disabled', false);
        cs.code = [];
        cs.updateCodeAsterisks();
      },100);
    };

    this.buttonDown = function(code){
      $('.electronic_keys-personal-code .error').hide();

      if(code == "erase"){
        if(this.code.length == 0){
          $('.electronic_keys-personal-code').hide();
          this.status = "list";
        }else{
          this.code.splice(-1,1);
        }
      }else if(code == "submit"){
        code = this.code.join('');

        if(code == "1111"){
          this.openDoor();
        }else{
          $('.electronic_keys-personal-code .error').show();
          $('.electronic_keys-personal-code .error').html('* PIN incorrecto');
          this.code = [];
        }

      }else{
        if(this.code.length < 4){
          this.code.push(code);
        }
      }

      console.log(this.code);
      this.updateCodeAsterisks();
    }

    this.openDoor = function(){

      this.status = "waiting";

      $('.electronic_keys-personal-code').hide();
      $('.electronic_keys-opendoor').show();
      $('.electronic_keys-opendoor #waiting').show();
      $('.electronic_keys-opendoor #success').hide();

      Server.send({
        route : [PrivateData.get('current_server_portal'),'app',"v" + app.PORTAL_VERSION,'electronic_keys','open'],
        data : {
          id: this.door_id
        },
        callback : function(data, success){
          console.log(data);
          if(success){
            if(data.status == "success"){
              $('.electronic_keys-opendoor #waiting').hide();
              $('.electronic_keys-opendoor #success').show();
            }else{
              Alert.open('Lo Sentimos','Ocurrió un error al intentar conectar con el dispositivo, por favor intenta nuevamente.','Aceptar');

              $('.electronic_keys-opendoor').hide();
              $('.electronic_keys-personal-code').show();
            }
          }else{
            Alert.open('Lo Sentimos','Ocurrió un error al intentar enviar los datos, por favor intenta nuevamente.','Aceptar');

            $('.electronic_keys-opendoor').hide();
            $('.electronic_keys-personal-code').show();
          }
        }
      });
    };

    this.endOpen = function(){
      $('.electronic_keys-personal-code').hide();
      $('.electronic_keys-opendoor').hide();
      this.status = "list";
    };

    this.back = function(){
      if(this.status == "list"){
        navigator.app.exitApp();
      }else{
        this.endOpen();
      }
    };

  }
</script>