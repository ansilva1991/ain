<div class="payment-methods-siro">
  <h1>¿Comó querés pagar?</h1>
  <h3>Por favor, seleccioná que método de pago querés utilizar</h3>
  <button type="button" onclick="cs.openRedLink();">
    <img src="img/logo_redlink.png">
    <img src="img/logo_pagomiscuentas.png">
    <div>PAGOMISCUENTAS | RED LINK</div>
  </button>
  <div class="separator"></div>
  <button type="button" onclick="cs.openRapipagoPDF();">
    <img src="img/logo_pagofacil.png">
    <img src="img/logo_rapipago.png">
    <div>RAPIPAGO | PAGO FACÍL</div>
  </button>
</div>

<div class="payment-methods-siro-redlink">
  <img src="img/logo_redlink.png">
  <img src="img/logo_pagomiscuentas.png">

  <h3>Lee las siguientes instrucciones para realizar tu pago mediante PagoMisCuentas o Red Link</h3>
  <h5>1. Ingresa desde la opción PagoMisCuentas | RedLink de tu HomeBanking</h5>
  <h5>2. Luego ingresar con tu clave personal, seleccioná la categoría > <b>Consorcios</b> > <b>Banco Roela SIRO</b></h5>
  <h5>3. Ahora deberás ingresar tu código de pago electrónico:</h5>
  <button type="button" onclick="cs.copyPMC();">
    <h4 id="redlink_code"></h4>
    <h6>Copiar al portapapeles</h6>
  </button>
</div>

<div class="payment-methods-siro-rapipago">
  <img src="img/logo_pagofacil.png">
  <img src="img/logo_rapipago.png">

  <h3>Presenta este código en cualquier sucursal de Rapipago, PagoFacíl o Provincia Pagos</h3>

  <h4 id="rapipago_code"></h4>

  <h3>56 dígitos</h3>
  <button type="button" onclick="cs.sendRapiPagoToEmail()" id="btn_send_rapipago_to_email"><i class="fa fa-envelope"></i> Enviar instrucciones al email</button>
</div>

<script type="text/javascript">
  function c(){
    this.expenses_id;
    this.status = 0;

    this.start = function(opts){
      opts = opts || {};

      this.expenses_id = opts.expenses_id;
      this.back_to = opts.back_to;
      this.payment_ticket_id = opts.payment_ticket_id;

      app.liActive('expenses');

      this.getInfo(function(){
        app.pageLoading('hide');
      })
    }

    this.getInfo = function(callback){
      this.callback_get_info = callback;

      Server.send({
        route : [PrivateData.get('current_server_portal'),'app',"v" + app.PORTAL_VERSION,'group_current_accounts','payment_ticket_siro_info'],
        data : {
          payment_ticket_id: cs.payment_ticket_id
        },
        callback : function(data, success){
          console.info(data);
          if(success){

            $('#redlink_code').html(data.redlink_code);
            $('#rapipago_code').html(data.siro_close_barcode);

            cs.red_link_code = data.redlink_code;
            cs.rapipago_ticket_uri = data.rapipago_ticket_uri;
            cs.rapipago_ticket_filename = data.rapipago_ticket_filename;

            cs.callback_get_info();
          }else{
            Alert.open('Lo Sentimos','Ocurrió un error al intentar recibir los datos, por favor intenta nuevamente.','Aceptar');

            app.loadScreen(app.SCREENS.EXPENSES);
          }
        }
      });
    };

    this.openRapipagoPDF = function(){
      var file = cs.rapipago_ticket_filename;

      app.openFile(file,false,function(e){
        if(e.status == 9){
          cs.downloadRapipagoPDF();
        }
      });
    }

    this.downloadRapipagoPDF = function(){
      var uri = cs.rapipago_ticket_uri;
      var file = cs.rapipago_ticket_filename;

      ModalLoading.open("Descargando PDF", "Espere un momento...");

      Server.download({
        from: PrivateData.get('current_server_portal') + uri,
        to: file,
        progress: function(n){
        },
        success: function(e){
          ModalLoading.close();
          app.openFile(e.nativeURL,true);
        },
        error: function(er){
          ModalLoading.close();
          Alert.open('Lo Sentimos','Ocurrió un error al intentar descargar los datos, por favor intenta nuevamente.','Aceptar');
          console.log(er);
        },
        extra_data: {
          file_name: file
        }
      })
    }

    this.sendRapiPagoToEmail = function(callback){

      $('#btn_send_rapipago_to_email').html('<i class="fa fa-circle-o-notch fa-spin"></i> Enviando...');
      $('#btn_send_rapipago_to_email').prop('disabled', true);

      Server.send({
        route : [PrivateData.get('current_server_portal'),'app',"v" + app.PORTAL_VERSION,'group_current_accounts','send_ticket_siro_to_email'],
        data : {
          payment_ticket_id: cs.payment_ticket_id
        },
        callback : function(data, success){
          console.info(data);
          if(success){
            $('#btn_send_rapipago_to_email').html('<i class="fa fa-check"></i> Enviado Exitosamente');
          }else{
            $('#btn_send_rapipago_to_email').prop('disabled', false);
          }
        }
      });
    }

    this.back = function(){
      if(this.status == 0){
        app.loadScreen(app.SCREENS.EXPENSES_TICKET_PAYMENT);
      }else if(this.status == 1){
        $('.payment-methods-siro').show();
        $('.payment-methods-siro-redlink').hide();
        $('.payment-methods-siro-rapipago').hide();

        this.status = 0;
      }
    };

    this.openRedLink = function(){
      this.status = 1;
      $('.payment-methods-siro').hide();
      $('.payment-methods-siro-redlink').show();
    };

    this.openRapipago = function(){
      this.status = 1;
      $('.payment-methods-siro').hide();
      $('.payment-methods-siro-rapipago').show();
    };

    this.copyPMC = function(){
      cordova.plugins.clipboard.copy(cs.red_link_code, function(){
        Alert.open('Código de pago','El código se copió en el portapapeles.','Continuar');
      },function(){
        Alert.open('Lo sentimos','Ocurrió un error al intentar copiar al portapapeles, intente nuevamente.','Acepta');
      });
    };
  }
</script>